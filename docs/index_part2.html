<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width">
        <title>JS Lottery</title>
        <style>
            html,
            body {
              margin: 0;
              padding: 0;
            }

            body {
              display: -webkit-flex;
              display: -moz-flex;
              display: -ms-flex;
              display: -o-flex;
              display: flex;

              width: 100%;

              flex-direction: column;

              font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;
              letter-spacing: 0;
              font-weight: 400;
              font-style: normal;
              text-rendering: optimizeLegibility;
              -webkit-font-smoothing: antialiased;
            }
            
            .group {
              position: relative;
              width: 100%;
            }

            .cover {
                position: absolute;
                width: 50px;
                height: 50px;
                background-color: #ff0000;
                box-shadow: 0 0 0 1px #ddd;
                z-index: 10;
            }

            .num div,
            .go {
              position: absolute;
              width: 25%;
              height: 50px;
              line-height: 50px;
              text-align: center;
              background-color: #000;
              color: #fff;
            }

            .num div {
              -webkit-background-size: cover;
              background-size: cover;
            }

            .num div.addcover:before {
              position: absolute;
              content: '';
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background-color: rgba(0, 0, 0, .5);
            }

            .one {
                top: 0;
                left: 0;
            }

            .two {
                top: 0;
                left: 25%;
            }

            .three {
                top: 0;
                left: 50%;
            }

            .four {
                top: 0;
                right: 0;
            }

            .five {
                top: 25%;
                right: 0;
            }

            .six {
                top: 50%;
                right: 0;
            }

            .seven {
                right: 0;
                bottom: 0;
            }

            .eight {
                right: 25%;
                bottom: 0;
            }

            .nine {
                right: 50%;
                bottom: 0;
            }

            .ten {
                left: 0;
                bottom: 0;
            }

            .eleven {
                left: 0;
                bottom: 25%;
            }

            .twelve {
                left: 0;
                bottom: 50%;
            }

            .go {
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
            }

            input {
                margin: 20px;
                padding: 5px;
                height: 44px;
                border: 1px solid #333;
                line-height: 44px;
                color: #333;
                font-size: 14px;
            }

            .reset_btn {
                margin: 20px;
                height: 44px;
                line-height: 44px;
                text-align: center;
                background-color: #5D563A;
                font-size: 14px;
                color: #fff;
            }

        </style>
    </head>
    <body>
        <div class="group">
            <div class="num">
                <div class="addcover one" style="background-image: url('http://www.gratisography.com/pictures/361_1.jpg')"></div>
                <div class="addcover two" style="background-image: url('http://www.gratisography.com/pictures/360_1.jpg')"></div>
                <div class="addcover three" style="background-image: url('http://www.gratisography.com/pictures/338_1.jpg')"></div>
                <div class="addcover four" style="background-image: url('http://www.gratisography.com/pictures/342_1.jpg')"></div>
                <div class="addcover five" style="background-image: url('http://www.gratisography.com/pictures/347_1.jpg')"></div>
                <div class="addcover six" style="background-image: url('http://www.gratisography.com/pictures/350_1.jpg')"></div>
                <div class="addcover seven" style="background-image: url('http://www.gratisography.com/pictures/357_1.jpg')"></div>
                <div class="addcover eight" style="background-image: url('http://www.gratisography.com/pictures/340_1.jpg')"></div>
                <div class="addcover nine" style="background-image: url('http://www.gratisography.com/pictures/342_1.jpg')"></div>
                <div class="addcover ten" style="background-image: url('http://www.gratisography.com/pictures/338_1.jpg')"></div>
                <div class="addcover eleven" style="background-image: url('http://www.gratisography.com/pictures/360_1.jpg')"></div>
                <div class="addcover twelve" style="background-image: url('http://www.gratisography.com/pictures/357_1.jpg')"></div>
            </div>
            <div class="go"> RESULT </div>
        </div>

        <input type="number" name="circle" placeholder="設定 ajax 回來多轉的圈數" value=2>
        <input type="number" name="result" placeholder="設定 ajax 回來的結果" value=5>

        <div class="reset_btn"> 重新開始 </div>
    </body>

    <script type="text/javascript">

        // handle multiple browsers for requestAnimationFrame()
        window.requestAFrame = (function () {
            return window.requestAnimationFrame ||
                    window.webkitRequestAnimationFrame ||
                    window.mozRequestAnimationFrame ||
                    window.oRequestAnimationFrame ||
                    // if all else fails, use setTimeout
                    function (callback) {
                        return window.setTimeout(callback, 1000 / 60); // shoot for 60 fps
                    };
        })();

        // handle multiple browsers for cancelAnimationFrame()
        window.cancelAFrame = (function () {
            return window.cancelAnimationFrame ||
                    window.webkitCancelAnimationFrame ||
                    window.mozCancelAnimationFrame ||
                    window.oCancelAnimationFrame ||
                    function (id) {
                        window.clearTimeout(id);
                    };
        })();

        function getTime(t) {
            var tt = Math.round(t * 100 / 24 * 100);
            return tt;
        }

        function Lottery(element, options){
            
            var _this = this;

            _this._parent = element,
            _this._g = _this._parent.querySelectorAll('div'),
            _this._gg = [].slice.call(_this._g);

            _this.cover = document.querySelector('.cover'); // object
            _this.classnames = ['one','two','three','four','five','six','seven','eight','nine','ten','eleven','twelve'];

            _this.fps = 15;

            _this._num = 0,
            _this._numTwo = 0,
            _this._lastNum = 0,
            _this._lastMaxNum = options.lastMaxNum || 2;

            _this._defaultWidth = 0,
            _this._defaultHeight = 0;

            _this._stop = false,
            _this._resultNum = null;

            _this._isStarting = false;

            _this.init();
        }

        Lottery.prototype = {
            constructor: Lottery,

            init: function(){

                var _this = this;

                _this.setItemHeight();
                _this.bindEvent();
                _this.doAnimate();

            },

            resetAllStatus: function() {
                var _this = this;

                _this._gg.forEach((e, i) => {
                    if (!e.classList.contains('addcover')) {
                        e.classList.add('addcover');
                    }
                });
            },

            setItemHeight: function (){
                var _this = this;

                // num
                _this._defaultWidth = Math.round(_this._parent.clientWidth / 4);
                _this._defaultHeight = _this._defaultWidth;

                // child
                _this._gg.forEach((e, i) => {
                    e.style.width = _this._defaultWidth + 'px';
                    e.style.height = _this._defaultHeight + 'px';
                });

                // parent
                _this._parent.style.height = _this._defaultHeight * 4 + 'px';
            },

            bindEvent: function (){
                var _this = this;
                var _setItemHeight = _this.setItemHeight.bind(this);

                window.addEventListener('resize', _setItemHeight, false);
            },

            doAnimateAjax: function (_resultNum){
                var _this = this;

                // index 從 1 開始
                var _index = +(_this._resultNum);

                (function animateTwo() {

                    _this.resetAllStatus();
                    _this._gg[_this._numTwo].classList.remove('addcover');

                    _this._numTwo++;

                    if (_this._numTwo > _index - 1) {
                        
                        _this.resetSetting();
                        return;
                    }

                    setTimeout(function() {
                        requestAnimationFrame(animateTwo);
                    }, 1000 / _this.fps);

                })()
            },

            doAnimate: function(){

                var _this = this;

                if (_this._isStarting === true) {
                    return;   
                } else {
                    _this._isStarting = true;
                }

                (function animate() {

                    _this.resetAllStatus();
                    _this._gg[_this._num].classList.remove('addcover');

                    _this._num++;

                    if (_this._num > 11) {
                        _this._num = 0;

                        if (_this._stop === true) {
                            _this._lastNum++;
                        }

                        if (_this._lastNum > _this._lastMaxNum) {
                            _this.doAnimateAjax(_this._resultNum)
                            return;
                        }

                    }

                    setTimeout(function() {
                        requestAnimationFrame(animate);
                    }, 1000 / _this.fps);

                })()

            },

            resetSetting: function(){
                _this._isStarting = false;
                _this._lastNum = 0;
                _this._resultNum = null;
                _this._numTwo = 0;
                _this._stop = false;
            },

            setResultItem: function(num){
                var _this = this;
                _this._resultNum = num;
            },

            stop: function(){
                var _this = this;
                _this._stop = true;
            },

            setCircleNum: function(num){
                var _this = this;
                _this._lastMaxNum = num;
            }
        }

        var _lottery = new Lottery(
            document.querySelector('.num'),
            {
                lastMaxNum: 5
            }
        );

        var _stopEle = document.querySelector('.go');

        _stopEle.addEventListener('click', function(){

            var _circle = document.querySelector('input[name="circle"]').value === 2 ? 2 : document.querySelector('input[name="circle"]').value
            var _result = document.querySelector('input[name="result"]').value === 5 ? 5 : document.querySelector('input[name="result"]').value

            // ajax callback
            _lottery.setCircleNum(_circle);
            _lottery.setResultItem(_result);
            _lottery.stop();

        });

        var _resetEle = document.querySelector('.reset_btn');

        _resetEle.addEventListener('click', function(){
            _lottery.doAnimate();
        });

    </script>
</html>