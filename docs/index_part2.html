<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width">
        <title>JS Lottery</title>
        <style>
            html,
            body {
              margin: 0;
              padding: 0;
            }

            body {
              display: -webkit-flex;
              display: -moz-flex;
              display: -ms-flex;
              display: -o-flex;
              display: flex;

              width: 100%;

              flex-direction: column;

              font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;
              letter-spacing: 0;
              font-weight: 400;
              font-style: normal;
              text-rendering: optimizeLegibility;
              -webkit-font-smoothing: antialiased;
            }
            
            .group {
              position: relative;
              width: 100%;
            }

            .fooObject {
                position: absolute;
                width: 50px;
                height: 50px;
                background-color: #f9f9f9;
                box-shadow: 0 0 0 1px #ddd;
                z-index: 10;
            }

            .num div,
            .go {
              position: absolute;
              width: 25%;
              height: 50px;
              line-height: 50px;
              text-align: center;
              background-color: #000;
              color: #fff;
            }

            .num div {
              -webkit-background-size: cover;
              background-size: cover;
            }

            .num div.addcover:before {
              position: absolute;
              content: '';
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background-color: rgba(0, 0, 0, .5);
            }

            .one {
                top: 0;
                left: 0;
            }

            .two {
                top: 0;
                left: 25%;
            }

            .three {
                top: 0;
                left: 50%;
            }

            .four {
                top: 0;
                right: 0;
            }

            .five {
                top: 25%;
                right: 0;
            }

            .six {
                top: 50%;
                right: 0;
            }

            .seven {
                right: 0;
                bottom: 0;
            }

            .eight {
                right: 25%;
                bottom: 0;
            }

            .nine {
                right: 50%;
                bottom: 0;
            }

            .ten {
                left: 0;
                bottom: 0;
            }

            .eleven {
                left: 0;
                bottom: 25%;
            }

            .twelve {
                left: 0;
                bottom: 50%;
            }

            .go {
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
            }

            input {
                margin: 20px;
                padding: 5px;
                height: 44px;
                border: 1px solid #333;
                line-height: 44px;
                color: #333;
                font-size: 14px;
            }

        </style>
    </head>
    <body>
        <div class="group">
            <div class="fooObject"></div>
            <div class="num">
                <div class="addcover one" style="background-image: url('http://www.gratisography.com/pictures/361_1.jpg')"></div>
                <div class="addcover two" style="background-image: url('http://www.gratisography.com/pictures/360_1.jpg')"></div>
                <div class="addcover three" style="background-image: url('http://www.gratisography.com/pictures/338_1.jpg')"></div>
                <div class="addcover four" style="background-image: url('http://www.gratisography.com/pictures/342_1.jpg')"></div>
                <div class="addcover five" style="background-image: url('http://www.gratisography.com/pictures/347_1.jpg')"></div>
                <div class="addcover six" style="background-image: url('http://www.gratisography.com/pictures/350_1.jpg')"></div>
                <div class="addcover seven" style="background-image: url('http://www.gratisography.com/pictures/357_1.jpg')"></div>
                <div class="addcover eight" style="background-image: url('http://www.gratisography.com/pictures/340_1.jpg')"></div>
                <div class="addcover nine" style="background-image: url('http://www.gratisography.com/pictures/342_1.jpg')"></div>
                <div class="addcover ten" style="background-image: url('http://www.gratisography.com/pictures/338_1.jpg')"></div>
                <div class="addcover eleven" style="background-image: url('http://www.gratisography.com/pictures/360_1.jpg')"></div>
                <div class="addcover twelve" style="background-image: url('http://www.gratisography.com/pictures/357_1.jpg')"></div>
            </div>
            <div class="go">Go</div>
        </div>

        <input type="number" name="circle" placeholder="設定 ajax 回來多轉的圈數" value=2>
        <input type="number" name="result" placeholder="設定 ajax 回來的結果" value=5>
    </body>

    <script type="text/javascript">

        // handle multiple browsers for requestAnimationFrame()
        window.requestAFrame = (function () {
            return window.requestAnimationFrame ||
                    window.webkitRequestAnimationFrame ||
                    window.mozRequestAnimationFrame ||
                    window.oRequestAnimationFrame ||
                    // if all else fails, use setTimeout
                    function (callback) {
                        return window.setTimeout(callback, 1000 / 60); // shoot for 60 fps
                    };
        })();

        // handle multiple browsers for cancelAnimationFrame()
        window.cancelAFrame = (function () {
            return window.cancelAnimationFrame ||
                    window.webkitCancelAnimationFrame ||
                    window.mozCancelAnimationFrame ||
                    window.oCancelAnimationFrame ||
                    function (id) {
                        window.clearTimeout(id);
                    };
        })();

        function getTime(t) {
            var tt = Math.round(t * 100 / 24 * 100);
            return tt;
        }

        var requestId = 0;
        var startime = 0;
        var lpos = 0;
        var elm;

        var foo = document.querySelector('.fooObject'); // object
        var num = null;
        var index = ['one','two','three','four','five','six','seven','eight','nine','ten','eleven','twelve'];

        var fps = 30;

        (function animate() {
            num++;

            if (num > 11) {
                num = 0;
            }

            foo.className = 'fooObject';
            foo.classList.add(index[num])

          setTimeout(function() {
            requestAnimationFrame(animate);
          }, 1000 / fps);
        })()

        function Lottery(element, options){
            var _this = this;

            _this._parent = element,
            _this._g = _this._parent.querySelectorAll('div'),
            _this._gg = [].slice.call(_this._g);

            _this._num = 0,
            _this._lastNum = 0,
            _this._lastMaxNum = options.lastMaxNum || 2;

            _this._defaultWidth = 0,
            _this._defaultHeight = 0;

            _this._stop = false,
            _this._resultNum = null;

            _this.init();
        }

        Lottery.prototype = {
            constructor: Lottery,

            init: function(){

                var _this = this;

                _this.setItemHeight();
                _this.bindEvent();
                // _this.doit();
                // _this.doSomething();
            },

            resetAllStatus: function() {
                var _this = this;

                _this._gg.forEach((e, i) => {
                    if (!e.classList.contains('addcover')) {
                        e.classList.add('addcover');
                    }

                    if (e.classList.contains('big')) {
                        e.classList.remove('big');
                    }
                });
            },

            setItemHeight: function (){
                var _this = this;

                // num
                _this._defaultWidth = Math.round(_this._parent.clientWidth / 4);
                _this._defaultHeight = _this._defaultWidth;

                // child
                _this._gg.forEach((e, i) => {
                    e.style.width = _this._defaultWidth + 'px';
                    e.style.height = _this._defaultHeight + 'px';
                });

                // parent
                _this._parent.style.height = _this._defaultHeight * 4 + 'px';
            },

            bindEvent: function (){
                var _this = this;
                var _setItemHeight = _this.setItemHeight.bind(this);

                window.addEventListener('resize', _setItemHeight, false);
            },

            doSomething: function(){

                var _this = this;


                // place the rAF *before* the render() to assure as close to
                // 60fps with the setTimeout fallback.


            },

            doit: function (){
                var _this = this;

                _this._gg.forEach(function(e, i){
                    setTimeout(function(){

                        _this.resetAllStatus();
                        e.classList.remove('addcover');
                        _this._num++;

                        if (_this._num > 11) {
                            _this._num = 0;

                            if (_this._stop === true) {
                                _this._lastNum++;
                            }

                            if (_this._lastNum > _this._lastMaxNum) {
                                _this.ajaxResult(_this._resultNum)
                                return;
                            } else {
                                console.log('doit')
                                _this.doit();
                            }
                        }

                    }, (100 + (175 * _this._lastNum)) * (i + 1));

                });

            },

            ajaxResult: function (_resultNum){
                var _this = this;

                // index 從 1 開始
                var _index = +(_this._resultNum);

                var _resultArr = _this._gg.slice(0, _index);
                
                _resultArr.forEach(function(e, i){
                    setTimeout(function(){
                
                        _this.resetAllStatus();
                        e.classList.remove('addcover');

                    }, getTime(i + 1));

                });
            },

            ajaxComing: function(num){
                var _this = this;

                _this._stop = true;
                _this._resultNum = num;
            }
        }




        var _lottery = new Lottery(
            document.querySelector('.num'),
            {
                lastMaxNum: document.querySelector('input[name="circle"]').value === 0 ? 2 : document.querySelector('input[name="circle"]').value
            }
        );

        var _stopEle = document.querySelector('.go');

        _stopEle.addEventListener('click', function(){
            var _value = document.querySelector('input[name="result"]').value === 5 ? 5 : document.querySelector('input[name="result"]').value
            _lottery.ajaxComing(_value);
        })



        // var _parent = document.querySelector('.num'),
        //     _g = _parent.querySelectorAll('div'),
        //     _gg = [].slice.call(_g);

        // var _num = 0,
        //     _lastNum = 0,
        //     _lastMaxNum = 2;

        // var _defaultWidth = 0,
        //     _defaultHeight = 0;

        // var _stop = false,
        //     _resultNum = null;

        // function ajaxResult(_resultNum){

        //     // index 從 1 開始
        //     var _index = _resultNum + 1;

        //     var _resultArr = _gg.slice(0, _index);
            
        //     _resultArr.forEach(function(e, i){
        //         setTimeout(function(){
            
        //             resetAllStatus();
        //             e.classList.remove('addcover');

        //         }, getTime(i + 1));

        //     });
        // }

        
        // function doit(){
        //     _gg.forEach(function(e, i){
        //         setTimeout(function(){

        //             resetAllStatus();
        //             e.classList.remove('addcover');
        //             _num++;

        //             if (_num > 11) {
        //                 _num = 0;

        //                 if (_stop === true) {
        //                     _lastNum++;
        //                 }

        //                 if (_lastNum > _lastMaxNum) {
        //                     ajaxResult(_resultNum)
        //                     return;
        //                 } else {
        //                     console.log('doit')
        //                     doit();
        //                 }
        //             }

        //         }, (100 + (175 * _lastNum)) * (i + 1));

        //     });

        // }

        // function resetAllStatus() {
        //     _gg.forEach((e, i) => {
        //         if (!e.classList.contains('addcover')) {
        //             e.classList.add('addcover');
        //         }

        //         if (e.classList.contains('big')) {
        //             e.classList.remove('big');
        //         }
        //     });
        // }

        // function setItemHeight(){

        //     // num
        //     _defaultWidth = Math.round(_parent.clientWidth / 4);
        //     _defaultHeight = _defaultWidth;

        //     // child
        //     _gg.forEach((e, i) => {
        //         e.style.width = _defaultWidth + 'px';
        //         e.style.height = _defaultHeight + 'px';
        //     });

        //     // parent
        //     _parent.style.height = _defaultHeight * 4 + 'px';
        // }

        // function bindEvent(){
        //     var _stopEle = document.querySelector('.go');

        //     _stopEle.addEventListener('click', function(){
        //         _stop = true;
        //         _resultNum = 5;
        //     })
        // }

        // window.addEventListener('resize', setItemHeight, false);

        // document.addEventListener('DOMContentLoaded', init.bind(this), false);

        // function init(){
            // setItemHeight();
            // bindEvent();
            // doit();
        // }


    </script>
</html>